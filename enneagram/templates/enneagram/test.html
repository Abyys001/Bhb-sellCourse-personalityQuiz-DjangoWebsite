{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block title %}
  {% if lang == "en" %}
    {% trans "Enneagram Test" %}
  {% else %}
    {% trans "آزمون انیاگرام" %}
  {% endif %}
{% endblock %}
{% block extra_head %}

<style>
    :root {
      --gold:rgb(255, 255, 255);
      --gold-dark: #BFA100;
      --black: #181818;
      --black-light: #232323;
      --white: #fff;
    }
  
    .question-box {
      max-width: 600px;
      margin: 100px auto;
      background-color: var(--black);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(255,215,0,0.10);
      position: relative;
      color: var(--gold);
      border: 2px solid #FFD700;
    }
  
    .question-item {
      display: none;
      transition: opacity 0.5s ease-in-out;
    }
  
    .question-item.active {
      display: block;
      opacity: 1;
    }
  
    .question-fadeout {
      opacity: 0;
    }
  
    .question-options label {
      display: block;
      padding: 10px;
      border: 1.5px solid #FFD700;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: 0.3s;
      color: var(--gold);
      background-color: var(--black-light);
      font-weight: 500;
    }
  
    .question-options label:hover,
    .question-options label:focus-within {
      background-color: var(--gold);
      color: var(--black);
      border-color: var(--gold-dark);
    }
  
    .question-options input[type="radio"] {
      accent-color: var(--gold);
      margin-left: 8px;
      vertical-align: middle;
    }
  
    .question-box p {
      font-size: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    
  
    #submitBtn, #backBtn, #startBtn, #nextBtn {
      background: var(--gold);
      color: var(--black);
      font-weight: 600;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 16px;
      border: 2px solid transparent;
      transition: 0.3s ease, background 0.2s, color 0.2s, border-color 0.2s;
      box-shadow: 0 2px 8px 0 rgba(255,215,0,0.10);
      margin: 0 5px;
    }
  
    #submitBtn:hover, #backBtn:hover, #startBtn:hover, #nextBtn:hover {
      color: var(--gold);
      border-color: var(--gold);
      background: rgba(255, 255, 255, 0.15);
    }
    
    #nextBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .question-item {
      opacity: 0;
      visibility: hidden;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    
    .question-item.active {
      opacity: 1;
      visibility: visible;
      position: relative;
    }
    body {
      background-color: var(--black);
      height: 100vh;
      margin: 0;
    }
    .question-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .start-container {
      text-align: center;
      padding: 20px;
    }
    .instructions {
      margin-bottom: 20px;
      color: var(--gold);
    }
    .lang-switch {
      text-align: center;
      margin-bottom: 20px;
    }
    .lang-switch form {
      display: inline-block;
    }
    .lang-switch button {
      background: var(--black-light);
      color: var(--gold);
      border: 1px solid var(--gold-dark);
      border-radius: 5px;
      padding: 6px 16px;
      margin: 0 4px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .lang-switch button.active,
    .lang-switch button:focus {
      background: var(--gold);
      color: var(--black);
      border-color: var(--gold-dark);
    }
    @media (max-width: 500px) {
      .question-nav {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
  
{% endblock %}

{% block content %}

<div class="question-box" dir="{% if lang == 'en' %}ltr{% else %}rtl{% endif %}">
  <div class="lang-switch">
    <form method="get" action="">
      <button type="submit" name="lang" value="fa" {% if lang == "fa" %}class="active"{% endif %}>
        فارسی
      </button>
      <button type="submit" name="lang" value="en" {% if lang == "en" %}class="active"{% endif %}>
        English
      </button>
    </form>
  </div>
  <form id="enneagramForm" method="post" action="{% url 'submit_test' %}">
    {% csrf_token %}
    <input type="hidden" name="lang" value="{{ lang }}">
    
    <!-- Start Test Section -->
    <div id="startTest" class="start-container">
      <div class="instructions">
        <h3>
          {% if lang == "en" %}
            {% trans "Enneagram Test" %}
          {% else %}
            {% trans "آزمون انیاگرام" %}
          {% endif %}
        </h3>
        <p>
          {% if lang == "en" %}
            {% blocktrans count questions_count=questions|length %}
              This test contains {{ questions_count }} questions.
            {% plural %}
              This test contains {{ questions_count }} questions.
            {% endblocktrans %}
          {% else %}
            {% blocktrans count questions_count=questions|length %}
              این آزمون شامل {{ questions_count }} سوال می‌باشد
            {% plural %}
              این آزمون شامل {{ questions_count }} سوال می‌باشد
            {% endblocktrans %}
          {% endif %}
        </p>
        <p>
          {% if lang == "en" %}
            {% trans "Please answer the questions carefully." %}
          {% else %}
            {% trans "لطفاً با دقت به سوالات پاسخ دهید" %}
          {% endif %}
        </p>
      </div>
      <button type="button" id="startBtn" class="btn btn-gold">
        {% if lang == "en" %}
          {% trans "Start Test" %}
        {% else %}
          {% trans "شروع آزمون" %}
        {% endif %}
      </button>
    </div>
    
    <!-- Questions Section (hidden initially) -->
    <div id="questionsSection" style="display:none;">
      {% for q in questions %}
        <div class="question-item" data-question-id="{{ q.id }}">
          <p><strong>{{ q.text }}</strong></p>
          <div class="question-options">
            {% for opt in q.options.all %}
              <label>
                <input type="radio" name="question_{{ q.id }}" value="{{ opt.id }}" required>
                {{ opt.text }}
              </label>
            {% empty %}
              <p style="color: red;">
                {% if lang == "en" %}
                  No options available for this question
                {% else %}
                  هیچ گزینه‌ای برای این سوال موجود نیست
                {% endif %}
              </p>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
      <div class="question-nav">
        <button type="button" id="nextBtn" style="display: none;">
          {% if lang == "en" %}
            {% trans "Next" %}
          {% else %}
            {% trans "بعدی" %}
          {% endif %}
        </button>
        <button type="button" id="backBtn" style="display: none;">
          {% if lang == "en" %}
            {% trans "Back" %}
          {% else %}
            {% trans "قبلی" %}
          {% endif %}
        </button>
        <button type="submit" id="submitBtn" style="display: none;">
          {% if lang == "en" %}
            {% trans "Submit" %}
          {% else %}
            {% trans "ارسال" %}
          {% endif %}
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  const form = document.getElementById("enneagramForm");
  const startBtn = document.getElementById("startBtn");
  const startTest = document.getElementById("startTest");
  const questionsSection = document.getElementById("questionsSection");
  const questions = Array.from(document.querySelectorAll(".question-item"));
  const backBtn = document.getElementById("backBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  let currentIndex = 0;

  // Start button click handler
  startBtn.addEventListener("click", function() {
    startTest.style.display = "none";
    questionsSection.style.display = "block";
    showQuestion(currentIndex);
  });

  // Helper to show/hide navigation buttons
  function updateNavButtons() {
    if (currentIndex === 0) {
      backBtn.style.display = "none";
    } else {
      backBtn.style.display = "";
    }
    
    if (currentIndex === questions.length - 1) {
      nextBtn.style.display = "none";
      submitBtn.style.display = "";
    } else {
      nextBtn.style.display = "";
      submitBtn.style.display = "none";
    }
  }

  // Show only the current question
  function showQuestion(index) {
    questions.forEach((q, i) => {
      if (i === index) {
        q.classList.add("active");
        q.style.display = "";
      } else {
        q.classList.remove("active", "question-fadeout");
        q.style.display = "none";
      }
    });
    updateNavButtons();
    
    // Disable next button initially
    if (currentIndex < questions.length - 1) {
      nextBtn.disabled = true;
    }
  }

  // Next question on answer
  questions.forEach((q, index) => {
    const inputs = q.querySelectorAll("input[type=radio]");
    inputs.forEach(input => {
      input.addEventListener("change", () => {
        // Enable next button when an option is selected
        if (currentIndex < questions.length - 1) {
          nextBtn.disabled = false;
        }
      });
    });
  });

  // Next button logic
  nextBtn.addEventListener("click", () => {
    if (currentIndex < questions.length - 1) {
      questions[currentIndex].classList.remove("active");
      questions[currentIndex].classList.add("question-fadeout");
      setTimeout(() => {
        questions[currentIndex].style.display = "none";
        currentIndex++;
        showQuestion(currentIndex);
        nextBtn.disabled = true; // Disable until next selection
      }, 300);
    }
  });

  // Back button logic
  backBtn.addEventListener("click", () => {
    if (currentIndex > 0) {
      questions[currentIndex].classList.remove("active");
      questions[currentIndex].classList.add("question-fadeout");
      setTimeout(() => {
        questions[currentIndex].style.display = "none";
        currentIndex--;
        showQuestion(currentIndex);
      }, 300);
    }
  });

  // Prevent auto submit on last question, show submit button instead
  form.addEventListener("submit", function(e) {
    // Check if all questions are answered
    const answeredQuestions = new Set();
    questions.forEach((q, index) => {
      const selectedOption = q.querySelector('input[type="radio"]:checked');
      if (selectedOption) {
        answeredQuestions.add(index);
      }
    });
    
    if (answeredQuestions.size < questions.length) {
      e.preventDefault();
      {% if lang == "en" %}
        alert('Please answer all questions before submitting.');
      {% else %}
        alert('لطفاً به همه سوالات پاسخ دهید.');
      {% endif %}
    }
  });
</script>
{% endblock %}